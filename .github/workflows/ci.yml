name: CI

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
            - develop

jobs:
    analyze:
        name: Analyze
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.24.0"
                  channel: "stable"

            - name: Setup Dart
              uses: dart-lang/setup-dart@v1

            - name: Get Melos
              run: dart pub global activate melos

            - name: Bootstrap
              run: dart run melos bootstrap

            - name: Analyze
              run: dart run melos run analyze

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.24.0"
                  channel: "stable"

            - name: Setup Dart
              uses: dart-lang/setup-dart@v1

            - name: Get Melos
              run: dart pub global activate melos

            - name: Bootstrap
              run: dart run melos bootstrap

            - name: Test
              run: dart run melos run test

    format:
        name: Format Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.24.0"
                  channel: "stable"

            - name: Setup Dart
              uses: dart-lang/setup-dart@v1

            - name: Get Melos
              run: dart pub global activate melos

            - name: Bootstrap
              run: dart run melos bootstrap

            - name: Check Format
              run: |
                  dart run melos run format
                  if ! git diff --exit-code --quiet; then
                    echo "Code formatting issues detected. Run 'dart run melos run format'"
                    git diff
                    exit 1
                  fi
